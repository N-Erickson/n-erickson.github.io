<!DOCTYPE html>
<html>
<head>
    <title>Local Sioux Falls Headlines</title>
    <meta http-equiv="refresh" content="300">
    <style>
        @font-face {
            font-family: 'Star 4 Radar';
            src: url('fonts/Star 4 Radar.ttf');
        }
        body {
            margin: 0;
            padding: 0;
        }
        #reminderContainer {
            width: 400px;
            height: 900px;
            background: #063359;
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden;
            color: white;
            font-family: Arial, sans-serif;
            box-shadow: 0px 0px 20px #FB8807;
        }
        #reminderHeader {
            width: 100%;
            height: 26px;
            background: #FB8807;
            text-align: center;
            font-size: 24px;
            line-height: 26px;
            font-family: 'Star 4 Radar', Arial, sans-serif;
        }
        #reminderContent {
            width: 100%;
            height: calc(100% - 26px);
            overflow: hidden;
            position: relative;
        }
        #newsList {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            transition: transform 0.5s ease;
        }
        .newsItem {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid #FB8807;
            background: rgba(251, 136, 7, 0.1);
            margin-bottom: 5px;
        }
        .newsItem img {
            width: 80px;
            height: 80px;
            margin-right: 15px;
            object-fit: cover;
            border: 2px solid #FB8807;
            border-radius: 4px;
            background: #0d4270;
        }
        .newsItem a {
            color: #FB8807;
            text-decoration: none;
            font-size: 16px;
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
        }
        .newsItem a:hover {
            text-decoration: underline;
        }
        .newsSummary {
            color: #ffffff;
            font-size: 14px;
            line-height: 1.4;
        }
        #errorMessage {
            color: #FB8807;
            text-align: center;
            padding: 20px;
            display: none;
        }
        .newsContent {
            flex: 1;
        }
    </style>
</head>
<body>
    <div id="reminderContainer">
        <div id="reminderHeader">
            <span>Local Sioux Falls Headlines</span>
        </div>
        <div id="reminderContent">
            <div id="errorMessage"></div>
            <div id="newsList"></div>
        </div>
    </div>

    <script>
        const PROXY_URLS = [
            'https://api.allorigins.win/raw?url=',
            'https://cors-anywhere.herokuapp.com/',
            'https://api.rss2json.com/v1/api.json?rss_url='
        ];

        const NEWS_CATEGORIES = {
            weather: ['weather', 'storm', 'forecast', 'temperature', 'snow', 'rain', 'climate'],
            sports: ['sports', 'football', 'basketball', 'baseball', 'tournament', 'game', 'score', 'team', 'playoff'],
            business: ['business', 'economy', 'market', 'company', 'store', 'restaurant', 'financial', 'money', 'bank'],
            politics: ['government', 'mayor', 'council', 'vote', 'election', 'policy', 'senator', 'republican', 'democrat'],
            crime: ['police', 'crime', 'arrest', 'investigation', 'court', 'law', 'sheriff', 'robbery', 'suspect'],
            community: ['community', 'event', 'festival', 'parade', 'celebration', 'school', 'local', 'neighborhood'],
            entertainment: ['movie', 'concert', 'music', 'theater', 'show', 'performance', 'art', 'museum'],
            health: ['health', 'medical', 'hospital', 'doctor', 'clinic', 'virus', 'disease', 'treatment'],
            education: ['education', 'school', 'university', 'student', 'teacher', 'class', 'academic'],
            development: ['construction', 'building', 'development', 'project', 'property', 'real estate']
        };

        const LOCAL_NEWS_SOURCES = [
            {
                name: 'KELO',
                shortName: 'KELO'
            },
            {
                name: 'Argus Leader',
                shortName: 'ARGUS'
            },
            {
                name: 'Dakota News',
                shortName: 'DAKOTA'
            },
            {
                name: 'KSFY',
                shortName: 'KSFY'
            }
        ];

        function getColorSchemeForCategory(category) {
            const schemes = {
                weather: ['87CEEB', '4682B4', '1E90FF'],      // Sky blues
                sports: ['FF6B6B', 'FF8E8E', 'FFB4B4'],       // Energetic reds
                business: ['4CAF50', '66BB6A', '81C784'],     // Professional greens
                politics: ['9C27B0', 'BA68C8', 'CE93D8'],     // Royal purples
                crime: ['F44336', 'EF5350', 'E57373'],        // Alert reds
                community: ['FF9800', 'FFA726', 'FFB74D'],    // Warm oranges
                entertainment: ['E91E63', 'EC407A', 'F06292'], // Vibrant pinks
                health: ['00BCD4', '26C6DA', '4DD0E1'],       // Medical blues
                education: ['3F51B5', '5C6BC0', '7986CB'],    // Academic blues
                development: ['795548', '8D6E63', 'A1887F']   // Earth browns
            };
            
            return schemes[category] || ['FB8807', 'FFA647', 'FFC487']; // Default orange scheme
        }

        function getRandomWord(text, minLength = 4) {
            const words = text.split(' ')
                .filter(word => word.length >= minLength)
                .filter(word => !word.toLowerCase().includes('sioux') && !word.toLowerCase().includes('falls'));
            return words[Math.floor(Math.random() * words.length)] || 'SF';
        }

        function getNewsCategory(title, description) {
            const content = (title + ' ' + description).toLowerCase();
            for (const [category, keywords] of Object.entries(NEWS_CATEGORIES)) {
                if (keywords.some(keyword => content.includes(keyword))) {
                    return category;
                }
            }
            return 'general';
        }

        function getImageForNews(title, description, link) {
            // Try to match to a local news source first
            const sourceMatch = LOCAL_NEWS_SOURCES.find(source => 
                link.toLowerCase().includes(source.name.toLowerCase())
            );
            
            if (sourceMatch) {
                return `https://via.placeholder.com/80/FB8807/FFFFFF?text=${encodeURIComponent(sourceMatch.shortName)}`;
            }

            // Get category and color scheme
            const category = getNewsCategory(title, description);
            const colors = getColorSchemeForCategory(category);
            const mainColor = colors[Math.floor(Math.random() * colors.length)];
            
            // Get a meaningful word from the title
            const keyword = getRandomWord(title) || category.toUpperCase();
            
            // Create different layout styles
            const layouts = [
                // Standard text
                `https://via.placeholder.com/80/${mainColor}/FFFFFF?text=${encodeURIComponent(keyword)}`,
                
                // Split design (two-tone)
                `https://via.placeholder.com/80/${mainColor}/FFFFFF/000000?text=${encodeURIComponent(keyword)}`,
                
                // Gradient suggestion through strips
                `https://via.placeholder.com/80/${mainColor}/FFFFFF/FFFFFF?text=${encodeURIComponent(keyword)}`,
                
                // Category indicator
                `https://via.placeholder.com/80/${mainColor}/FFFFFF?text=${encodeURIComponent(category.substring(0,2).toUpperCase() + '\n' + keyword)}`
            ];

            // Pick a random layout
            return layouts[Math.floor(Math.random() * layouts.length)];
        }

        async function tryFetchWithProxy(rssUrl, proxyUrl) {
            try {
                const response = await fetch(proxyUrl + encodeURIComponent(rssUrl));
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.text();
                return data;
            } catch (error) {
                console.error(`Error with proxy ${proxyUrl}:`, error);
                return null;
            }
        }

        async function processNewsItems(xmlDoc) {
            const items = xmlDoc.getElementsByTagName('item');
            const newsList = document.getElementById('newsList');
            newsList.innerHTML = '';

            for (let i = 0; i < Math.min(items.length, 10); i++) {
                const item = items[i];
                const title = item.getElementsByTagName('title')[0]?.textContent || 'No Title';
                const link = item.getElementsByTagName('link')[0]?.textContent || '#';
                let description = item.getElementsByTagName('description')[0]?.textContent || '';

                description = description.replace(/<[^>]*>/g, '');
                description = description.trim().substring(0, 150) + '...';

                const img = document.createElement('img');
                img.src = getImageForNews(title, description, link);
                img.onerror = () => {
                    img.src = `https://via.placeholder.com/80/FB8807/FFFFFF?text=SF`;
                };

                const newsItem = document.createElement('div');
                newsItem.className = 'newsItem';

                const contentDiv = document.createElement('div');
                contentDiv.className = 'newsContent';
                
                contentDiv.innerHTML = `
                    <a href="${link}" target="_blank">${title}</a>
                    <div class="newsSummary">${description}</div>
                `;

                newsItem.appendChild(img);
                newsItem.appendChild(contentDiv);
                newsList.appendChild(newsItem);
            }
        }

        async function fetchNews() {
            const rssUrl = 'https://news.google.com/rss/search?q=location:Sioux+Falls+when:7d&hl=en-US&gl=US&ceid=US:en';
            const newsList = document.getElementById('newsList');
            const errorMessage = document.getElementById('errorMessage');
            
            let success = false;
            
            for (const proxyUrl of PROXY_URLS) {
                const data = await tryFetchWithProxy(rssUrl, proxyUrl);
                if (data) {
                    try {
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(data, "text/xml");
                        
                        if (!xmlDoc.getElementsByTagName('parsererror').length) {
                            await processNewsItems(xmlDoc);
                            success = true;
                            break;
                        }
                    } catch (error) {
                        console.error('Error processing XML:', error);
                    }
                }
            }

            if (!success) {
                errorMessage.style.display = 'block';
                errorMessage.textContent = 'Unable to load news. Please try again later.';
            } else {
                errorMessage.style.display = 'none';
                startScrolling();
            }
        }

        function startScrolling() {
            const newsList = document.getElementById('newsList');
            const container = document.getElementById('reminderContent');
            let scrollPosition = 0;
            const scrollSpeed = 1;
            let isPaused = false;

            container.addEventListener('mouseenter', () => isPaused = true);
            container.addEventListener('mouseleave', () => isPaused = false);

            setInterval(() => {
                if (!isPaused) {
                    scrollPosition += scrollSpeed;
                    const maxScroll = newsList.scrollHeight - container.clientHeight;
                    
                    if (scrollPosition >= maxScroll) {
                        scrollPosition = 0;
                    }
                    
                    newsList.style.transform = `translateY(-${scrollPosition}px)`;
                }
            }, 50);
        }

        // Initial fetch and refresh every 5 minutes
        fetchNews();
        setInterval(fetchNews, 300000);
    </script>
</body>
</html>
